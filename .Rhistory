geom_boxplot(outlier.shape=NA) +
geom_jitter(size = 4, position=position_jitter(0.15)) +
scale_fill_manual(values=c("skyblue", "hotpink")) +
labs(title="Counts~Treatment",x="Group", y = "Gene Counts") +
theme_classic() +
theme(axis.line = element_line(colour = 'black', size = 1),
axis.ticks = element_line(colour = "black", size = 1),
legend.position="none",
axis.text=element_text(size=16),
axis.title=element_text(size=18,face="bold"),
plot.title = element_text(size=24, hjust = 0.4))
ggplot(genecounts, aes(treatment, genecounts, fill=treatment)) +
stat_compare_means(method = "t.test", size = 6, label.x = 1.5) +
geom_boxplot(outlier.shape=NA) +
geom_jitter(size = 4, position=position_jitter(0.15)) +
scale_fill_manual(values=c("skyblue", "hotpink")) +
labs(title="Counts~Treatment",x="Group", y = "Gene Counts") +
theme_classic() +
theme(axis.line = element_line(colour = 'black', size = 1),
axis.ticks = element_line(colour = "black", size = 1),
legend.position="none",
axis.text=element_text(size=16),
axis.title=element_text(size=18,face="bold"),
plot.title = element_text(size=24, hjust = 0.4))
ggplot(genecounts, aes(treatment, genecounts, fill=sex)) +
#  stat_compare_means(method = "t.test", size = 6, label.x = 1.5) +
geom_boxplot(outlier.shape=NA) +
geom_jitter(size = 4, position=position_jitter(0.15)) +
scale_fill_manual(values=c("skyblue", "hotpink")) +
labs(title="Counts~Treatment*Sex",x="Group", y = "Gene Counts") +
theme_classic() +
theme(axis.line = element_line(colour = 'black', size = 1),
axis.ticks = element_line(colour = "black", size = 1),
legend.position="none",
axis.text=element_text(size=16),
axis.title=element_text(size=18,face="bold"),
plot.title = element_text(size=24, hjust = 0.4))
ggplot(genecounts, aes(treatment, genecounts, fill=sex, color = sex)) +
#  stat_compare_means(method = "t.test", size = 6, label.x = 1.5) +
geom_boxplot(outlier.shape=NA) +
geom_jitter(size = 4, position=position_jitter(0.15)) +
scale_fill_manual(values=c("skyblue", "hotpink")) +
labs(title="Counts~Treatment*Sex",x="Group", y = "Gene Counts") +
theme_classic() +
theme(axis.line = element_line(colour = 'black', size = 1),
axis.ticks = element_line(colour = "black", size = 1),
legend.position="none",
axis.text=element_text(size=16),
axis.title=element_text(size=18,face="bold"),
plot.title = element_text(size=24, hjust = 0.4))
ggplot(genecounts, aes(treatment, genecounts, fill=sex, color = sex)) +
#  stat_compare_means(method = "t.test", size = 6, label.x = 1.5) +
geom_boxplot(outlier.shape=NA) +
geom_jitter(size = 4, position=position_jitter(0.15)) +
scale_fill_manual(values=c("skyblue", "hotpink")) +
scale_color_manual(values=c("skyblue", "hotpink")) +
labs(title="Counts~Treatment*Sex",x="Group", y = "Gene Counts") +
theme_classic() +
theme(axis.line = element_line(colour = 'black', size = 1),
axis.ticks = element_line(colour = "black", size = 1),
legend.position="none",
axis.text=element_text(size=16),
axis.title=element_text(size=18,face="bold"),
plot.title = element_text(size=24, hjust = 0.4))
counts3
genecounts %>%
ggplot(aes(treatment,genecounts, color = sex))+
stat_compare_means(method = "t.test", size = 6, label.x = 1.5) +
geom_boxjitter(outlier.color = NA, jitter.shape = 21,
alpha = 1,
width = 0.5,
jitter.height = 0.02, jitter.width = 0.02, errorbar.draw = TRUE,
position = position_dodge(0.8)) +
theme_classic()
genecounts %>%
ggplot(aes(treatment,genecounts))+
stat_compare_means(method = "t.test", size = 6, label.x = 1.5) +
geom_boxjitter(outlier.color = NA, jitter.shape = 21,
alpha = 1,
width = 0.5,
jitter.height = 0.02, jitter.width = 0.02, errorbar.draw = TRUE,
position = position_dodge(0.8)) +
theme_classic()
genecounts %>%
ggplot(aes(treatment,genecounts, color = treatment))+
stat_compare_means(method = "t.test", size = 6, label.x = 1.5) +
geom_boxjitter(outlier.color = NA, jitter.shape = 21,
alpha = 1,
width = 0.5,
jitter.height = 0.02, jitter.width = 0.02, errorbar.draw = TRUE,
position = position_dodge(0.8)) +
theme_classic()
genecounts %>%
ggplot(aes(treatment,genecounts, color = treatment))+
stat_compare_means(method = "t.test", size = 6, label.x = 1.5) +
geom_boxjitter(outlier.color = NA, jitter.shape = 21,
alpha = 1,
width = 0.5,
jitter.height = 0.02, jitter.width = 0.02, errorbar.draw = TRUE,
position = position_dodge(0.8)) +
scale_color_manual(values=c("skyblue", "hotpink")) +
theme_classic()
genecounts %>%
ggplot(aes(treatment,genecounts, color = treatment))+
stat_compare_means(method = "t.test", size = 6, label.x = 1.5) +
geom_boxjitter(outlier.color = NA, jitter.shape = 21,
alpha = 1,
width = 0.5,
jitter.height = 0.02, jitter.width = 0.02, errorbar.draw = TRUE,
position = position_dodge(0.8)) +
scale_color_manual(values=c("skyblue", "hotpink")) +
labs(title="Counts~Treatment",x="Group", y = "Gene Counts") +
theme_classic() +
theme(axis.line = element_line(colour = 'black', size = 1),
axis.ticks = element_line(colour = "black", size = 1),
legend.position="none",
axis.text=element_text(size=16),
axis.title=element_text(size=18,face="bold"),
plot.title = element_text(size=24, hjust = 0.4))
genecounts %>%
ggplot(aes(treatment,genecounts, fill = treatment))+
stat_compare_means(method = "t.test", size = 6, label.x = 1.5) +
geom_boxjitter(outlier.color = NA, jitter.shape = 21,
alpha = 1,
width = 0.5,
jitter.height = 0.02, jitter.width = 0.02, errorbar.draw = TRUE,
position = position_dodge(0.8)) +
scale_fill_manual(values=c("skyblue", "hotpink")) +
labs(title="Counts~Treatment",x="Group", y = "Gene Counts") +
theme_classic() +
theme(axis.line = element_line(colour = 'black', size = 1),
axis.ticks = element_line(colour = "black", size = 1),
legend.position="none",
axis.text=element_text(size=16),
axis.title=element_text(size=18,face="bold"),
plot.title = element_text(size=24, hjust = 0.4))
genecounts %>%
ggplot(aes(treatment,genecounts, fill = sex))+
stat_compare_means(method = "t.test", size = 6, label.x = 1.5) +
geom_boxjitter(outlier.color = NA, jitter.shape = 21,
alpha = 1,
width = 0.5,
jitter.height = 0.02, jitter.width = 0.02, errorbar.draw = TRUE,
position = position_dodge(0.8)) +
scale_fill_manual(values=c("skyblue", "hotpink")) +
labs(title="Counts~Treatment",x="Group", y = "Gene Counts") +
theme_classic() +
theme(axis.line = element_line(colour = 'black', size = 1),
axis.ticks = element_line(colour = "black", size = 1),
legend.position="none",
axis.text=element_text(size=16),
axis.title=element_text(size=18,face="bold"),
plot.title = element_text(size=24, hjust = 0.4))
genecounts %>%
ggplot(aes(treatment,genecounts, fill = sex))+
geom_boxjitter(outlier.color = NA, jitter.shape = 21,
alpha = 1,
width = 0.5,
jitter.height = 0.02, jitter.width = 0.02, errorbar.draw = TRUE,
position = position_dodge(0.8)) +
scale_fill_manual(values=c("skyblue", "hotpink")) +
labs(title="Counts~Treatment",x="Group", y = "Gene Counts") +
theme_classic() +
theme(axis.line = element_line(colour = 'black', size = 1),
axis.ticks = element_line(colour = "black", size = 1),
legend.position="none",
axis.text=element_text(size=16),
axis.title=element_text(size=18,face="bold"),
plot.title = element_text(size=24, hjust = 0.4))
genecounts %>%
ggplot(aes(treatment,genecounts, fill = treatment))+
stat_compare_means(method = "t.test", size = 6, label.x = 1.5) +
geom_boxjitter(outlier.color = NA, jitter.shape = 21,
alpha = 1,
width = 0.5,
jitter.height = 0.02, jitter.width = 0.02, errorbar.draw = TRUE,
position = position_dodge(0.8)) +
scale_fill_manual(values=c("skyblue", "hotpink")) +
labs(title="Counts~Treatment",x="Group", y = "Gene Counts") +
theme_classic() +
theme(axis.line = element_line(colour = 'black', size = 1),
axis.ticks = element_line(colour = "black", size = 1),
legend.position="none",
axis.text=element_text(size=16),
axis.title=element_text(size=18,face="bold"),
plot.title = element_text(size=24, hjust = 0.4))
lm1 <- lm(genecounts~treatment*sex, data = genecounts)
summary(lm1)
av1 <- ANOVA(genecounts~treatment*sex, data = genecounts)
av1 <- anova(genecounts~treatment*sex, data = genecounts)
genecounts %>%
ggplot(aes(treatment,genecounts, fill = sex))+
geom_boxjitter(outlier.color = NA, jitter.shape = 21,
alpha = 1,
width = 0.5,
jitter.height = 0.02, jitter.width = 0.02, errorbar.draw = TRUE,
position = position_dodge(0.8)) +
scale_fill_manual(values=c("skyblue", "hotpink")) +
labs(title="Counts~Treatment*Sex",x="Group", y = "Gene Counts") +
theme_classic() +
theme(axis.line = element_line(colour = 'black', size = 1),
axis.ticks = element_line(colour = "black", size = 1),
legend.position="none",
axis.text=element_text(size=16),
axis.title=element_text(size=18,face="bold"),
plot.title = element_text(size=24, hjust = 0.4))
genecounts %>%
ggplot(aes(treatment,genecounts, fill = sex))+
geom_boxjitter(outlier.color = NA, jitter.shape = 21,
alpha = 1,
width = 0.5,
jitter.height = 0.02, jitter.width = 0.02, errorbar.draw = TRUE,
position = position_dodge(0.8)) +
scale_fill_manual(values=c("skyblue", "hotpink")) +
labs(title="Counts~Treatment*Sex",x="Group", y = "Gene Counts") +
theme_classic() +
theme(axis.line = element_line(colour = 'black', size = 1),
axis.ticks = element_line(colour = "black", size = 1),
#        legend.position="none",
axis.text=element_text(size=16),
axis.title=element_text(size=18,face="bold"),
plot.title = element_text(size=24, hjust = 0.4))
genecounts %>%
ggplot(aes(treatment,genecounts, fill = sex))+
geom_boxjitter(outlier.color = NA, jitter.shape = 21,
alpha = 1,
width = 0.5,
jitter.height = 0.02, jitter.width = 0.02, errorbar.draw = TRUE,
position = position_dodge(0.8)) +
scale_fill_manual(values=c("hotpink", "skyblue")) +
labs(title="Counts~Treatment*Sex",x="Group", y = "Gene Counts") +
theme_classic() +
theme(axis.line = element_line(colour = 'black', size = 1),
axis.ticks = element_line(colour = "black", size = 1),
#        legend.position="none",
axis.text=element_text(size=16),
axis.title=element_text(size=18,face="bold"),
plot.title = element_text(size=24, hjust = 0.4))
cts <- read.csv("rawdata/KT_Counts.csv")
cts <- cts %>% %>% column_to_rownames(.,var = "X")
cts <- cts %>% column_to_rownames(.,var = "X")
View(cts)
id <- read.csv("rawdata/kim rnaseq phenodata.csv")
coldata <- id %>% column_to_rownames(.,var = "id")
all(rownames(coldata) == colnames(cts))
dds <- DESeqDataSetFromMatrix(countData = cts,
colData = coldata,
design= ~ treatment + sex + treatment:sex)
dds <- DESeq(dds)
resultsNames(dds) # lists the coefficients
res <- results(dds, name = "treatment_OPFR_vs_Oil")
# or to shrink log fold changes association with condition:
res.s <- lfcShrink(dds, coef="treatment_OPFR_vs_Oil", type="apeglm")
smallestGroupSize <- 3
keep <- rowSums(counts(dds) >= 10) >= smallestGroupSize
dds <- dds[keep,]
res <- results(dds, name = "treatment_OPFR_vs_Oil")
res
# Log fold change shrinkage for visualization and ranking
resLFC <- lfcShrink(dds, coef="treatment_OPFR_vs_Oil", type="apeglm")
resLFC
resOrdered <- res[order(res$pvalue),]
resOrdered
summary(res)
library(IHW)
resIHW <- results(dds, filterFun=ihw)
summary(resIHW)
sum(resIHW$padj < 0.1, na.rm=TRUE)
metadata(resIHW)$ihwResult
plotMA(res, ylim=c(-2,2))
plotMA(resLFC, ylim=c(-2,2))
#Alternative shrinkage estimators
resNorm <- lfcShrink(dds, coef=2, type="normal")
library(ashr)
resAsh <- lfcShrink(dds, coef=2, type="ashr")
par(mfrow=c(1,3), mar=c(4,4,2,1))
xlim <- c(1,1e5); ylim <- c(-3,3)
plotMA(resLFC, xlim=xlim, ylim=ylim, main="apeglm")
plotMA(resNorm, xlim=xlim, ylim=ylim, main="normal")
plotMA(resAsh, xlim=xlim, ylim=ylim, main="ashr")
dev.off()
plotCounts(dds, gene=which.min(res$padj), intgroup="treatment")
d <- plotCounts(dds, gene=which.min(res$padj), intgroup="treatment",
returnData=TRUE)
ggplot(d, aes(x=group, y=count)) +
geom_boxplot() +
geom_point(position=position_jitter(w=0.1,h=0))
ggplot(d, aes(x=group, y=treatment)) +
geom_boxplot() +
geom_point(position=position_jitter(w=0.1,h=0))
ggplot(d, aes(x=treatment, y=count)) +
geom_boxplot() +
geom_point(position=position_jitter(w=0.1,h=0))
mcols(res)$description
write.csv(as.data.frame(resOrdered),
file="results/HPC_bytreatment_DESeq_results.csv")
#variance stabilizing transformations
vsd <- vst(dds, blind=FALSE)
#regularized logarithm
rld <- rlog(dds, blind=FALSE)
head(assay(vsd), 3)
# this gives log2(n + 1)
ntd <- normTransform(dds)
library("vsn")
meanSdPlot(assay(ntd))
# this gives log2(n + 1)
ntd <- normTransform(dds)
library("vsn")
meanSdPlot(assay(ntd))
meanSdPlot(assay(vsd))
meanSdPlot(assay(rld))
coldata$treatment <- as.factor(coldata$treatment)
library("pheatmap")
df <- as.data.frame(colData(dds)[,c("treatment","sex")])
pheatmap(assay(ntd)[select,], cluster_rows=FALSE, show_rownames=FALSE,
cluster_cols=FALSE, annotation_col=df)
View(df)
# DESeq2
library(tidyverse)
library(DESeq2)
cts <- read.csv("rawdata/KT_Counts.csv")
cts <- cts %>% column_to_rownames(.,var = "X")
id <- read.csv("rawdata/kim rnaseq phenodata.csv")
coldata <- id %>% column_to_rownames(.,var = "id")
all(rownames(coldata) == colnames(cts))
### "Quick Start"
dds <- DESeqDataSetFromMatrix(countData = cts,
colData = coldata,
design= ~ treatment + sex + treatment:sex)
dds <- DESeq(dds)
resultsNames(dds) # lists the coefficients
res <- results(dds, name = "treatment_OPFR_vs_Oil")
# or to shrink log fold changes association with condition:
res.s <- lfcShrink(dds, coef="treatment_OPFR_vs_Oil", type="apeglm")
# lots of warning/errors
### DESeq pipeline
smallestGroupSize <- 3
keep <- rowSums(counts(dds) >= 10) >= smallestGroupSize
dds <- dds[keep,]
res <- results(dds, name = "treatment_OPFR_vs_Oil")
res
# Log fold change shrinkage for visualization and ranking
resLFC <- lfcShrink(dds, coef="treatment_OPFR_vs_Oil", type="apeglm")
resLFC
resOrdered <- res[order(res$pvalue),]
resOrdered
library(IHW)
resIHW <- results(dds, filterFun=ihw)
summary(resIHW)
sum(resIHW$padj < 0.1, na.rm=TRUE)
metadata(resIHW)$ihwResult
plotMA(res, ylim=c(-2,2))
plotMA(resLFC, ylim=c(-2,2))
#Alternative shrinkage estimators
resNorm <- lfcShrink(dds, coef=2, type="normal")
dev.off()
#Alternative shrinkage estimators
resNorm <- lfcShrink(dds, coef=2, type="normal")
library(ashr)
resAsh <- lfcShrink(dds, coef=2, type="ashr")
par(mfrow=c(1,3), mar=c(4,4,2,1))
xlim <- c(1,1e5); ylim <- c(-3,3)
plotMA(resLFC, xlim=xlim, ylim=ylim, main="apeglm")
plotMA(resNorm, xlim=xlim, ylim=ylim, main="normal")
plotMA(resAsh, xlim=xlim, ylim=ylim, main="ashr")
dev.off()
plotCounts(dds, gene=which.min(res$padj), intgroup="treatment")
d <- plotCounts(dds, gene=which.min(res$padj), intgroup="treatment",
returnData=TRUE)
ggplot(d, aes(x=treatment, y=count)) +
geom_boxplot() +
geom_point(position=position_jitter(w=0.1,h=0))
mcols(res)$description
write.csv(as.data.frame(resOrdered),
file="results/HPC_bytreatment_DESeq_results.csv")
#variance stabilizing transformations
vsd <- vst(dds, blind=FALSE)
#regularized logarithm
rld <- rlog(dds, blind=FALSE)
head(assay(vsd), 3)
# this gives log2(n + 1)
ntd <- normTransform(dds)
library("vsn")
meanSdPlot(assay(ntd))
meanSdPlot(assay(vsd))
meanSdPlot(assay(rld))
coldata$treatment <- as.factor(coldata$treatment)
library("pheatmap")
select <- order(rowMeans(counts(dds,normalized=TRUE)),
decreasing=TRUE)
df <- as.data.frame(colData(dds)[,c("treatment","sex")])
pheatmap(assay(ntd)[select,], cluster_rows=FALSE, show_rownames=FALSE,
cluster_cols=FALSE, annotation_col=df)
sampleDists <- dist(t(assay(vsd)))
library("RColorBrewer")
sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- paste(vsd$group, sep="-")
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
pheatmap(sampleDistMatrix,
clustering_distance_rows=sampleDists,
clustering_distance_cols=sampleDists,
col=colors)
plotPCA(vsd, intgroup=c("treatment"))
plotPCA(vsd, intgroup=c("sex"))
plotPCA(vsd, intgroup=c("E_Level"))
plotPCA(vsd, intgroup=c("E_level"))
mat <- assay(vsd)
mm <- model.matrix(~group, colData(vsd))
mat <- assay(vsd)
mm <- model.matrix(~treatment, colData(vsd))
mat <- limma::removeBatchEffect(mat, batch=vsd$batch, design=mm)
assay(vsd) <- mat
plotPCA(vsd, intgroup=c("treatment"))
par(mfrow=c(2,2),mar=c(2,2,1,1))
ylim <- c(-2.5,2.5)
resGA <- results(dds, lfcThreshold=.5, altHypothesis="greaterAbs")
resLA <- results(dds, lfcThreshold=.5, altHypothesis="lessAbs")
resG <- results(dds, lfcThreshold=.5, altHypothesis="greater")
resL <- results(dds, lfcThreshold=.5, altHypothesis="less")
drawLines <- function() abline(h=c(-.5,.5),col="dodgerblue",lwd=2)
plotMA(resGA, ylim=ylim); drawLines()
plotMA(resLA, ylim=ylim); drawLines()
plotMA(resG, ylim=ylim); drawLines()
plotMA(resL, ylim=ylim); drawLines()
rawcounts <- read.csv("rawdata/KT_Counts.csv")
bcx1 <- rawcounts %>% column_to_rownames(.,var = "X")
id <- read.csv("rawdata/kim rnaseq phenodata.csv")
idxx <- id %>% column_to_rownames(.,var = "id")
all(rownames(idxx) == colnames(bcx1)) #check they match
#### count checks
colSums(bcx1[,]) %>%
as_tibble_row() %>%
t() %>%
as.data.frame() %>%
rownames_to_column(var = 'id') %>%
dplyr::rename(genecounts = V1) -> genecounts
genecounts <- genecounts %>%
full_join(id)
genecounts %>%
ggplot(aes(genecounts)) +
geom_histogram(bins = 54,alpha =0.5,color = 'grey') +
theme_classic()
source("functions/geom_boxjitter.R")
genecounts %>%
ggplot(aes(treatment,genecounts, fill = treatment))+
stat_compare_means(method = "t.test", size = 6, label.x = 1.5) +
geom_boxjitter(outlier.color = NA, jitter.shape = 21,
alpha = 1,
width = 0.5,
jitter.height = 0.02, jitter.width = 0.02, errorbar.draw = TRUE,
position = position_dodge(0.8)) +
scale_fill_manual(values=c("skyblue", "hotpink")) +
labs(title="Counts~Treatment",x="Group", y = "Gene Counts") +
theme_classic() +
theme(axis.line = element_line(colour = 'black', size = 1),
axis.ticks = element_line(colour = "black", size = 1),
legend.position="none",
axis.text=element_text(size=16),
axis.title=element_text(size=18,face="bold"),
plot.title = element_text(size=24, hjust = 0.4))
library(limma)
library(tidyverse)
library(scales)
library(tidyverse)
library(DESeq2)
library(pheatmap)
library(annotables)
library(ggpubr)
rawcounts <- read.csv("rawdata/KT_Counts.csv")
bcx1 <- rawcounts %>% column_to_rownames(.,var = "X")
id <- read.csv("rawdata/kim rnaseq phenodata.csv")
idxx <- id %>% column_to_rownames(.,var = "id")
all(rownames(idxx) == colnames(bcx1)) #check they match
#### count checks
colSums(bcx1[,]) %>%
as_tibble_row() %>%
t() %>%
as.data.frame() %>%
rownames_to_column(var = 'id') %>%
dplyr::rename(genecounts = V1) -> genecounts
genecounts <- genecounts %>%
full_join(id)
genecounts %>%
ggplot(aes(genecounts)) +
geom_histogram(bins = 54,alpha =0.5,color = 'grey') +
theme_classic()
counts <- genecounts %>%
ggplot(aes(id,genecounts))+
geom_bar(stat = 'identity')+
coord_flip()
ggsave("imgs/braincounts_byid.png",counts, height = 5,width= 5, dpi = 150)
# all quite tight -- well processed.
####
source("functions/geom_boxjitter.R")
genecounts %>%
ggplot(aes(treatment,genecounts, fill = treatment))+
stat_compare_means(method = "t.test", size = 6, label.x = 1.5) +
geom_boxjitter(outlier.color = NA, jitter.shape = 21,
alpha = 1,
width = 0.5,
jitter.height = 0.02, jitter.width = 0.02, errorbar.draw = TRUE,
position = position_dodge(0.8)) +
scale_fill_manual(values=c("skyblue", "hotpink")) +
labs(title="Counts~Treatment",x="Group", y = "Gene Counts") +
theme_classic() +
theme(axis.line = element_line(colour = 'black', size = 1),
axis.ticks = element_line(colour = "black", size = 1),
legend.position="none",
axis.text=element_text(size=16),
axis.title=element_text(size=18,face="bold"),
plot.title = element_text(size=24, hjust = 0.4))
